package com.rusefi.output;

import com.rusefi.ConfigField;
import com.rusefi.ReaderState;
import com.rusefi.util.LazyFile;

import java.io.IOException;

import static com.rusefi.output.JavaSensorsConsumer.quote;

/**
 * here we tell the firmware what to log on SD card how
 *
 * @see DataLogConsumer
 */
public class SdCardFieldsContent {
    public static final String SD_CARD_OUTPUT_FILE_NAME = "console/binary_log/log_fields_generated.h";
    public static final String BOARD_LOOKUP_H = "#include \"board_lookup.h\"\n";
    private final StringBuilder body = new StringBuilder();

    public String[] home = new String[] {"test->reference"}; // technical debt: default value is only used by unit tests
    public String conditional;
    public Boolean isPtr = false;
    public String[] names;

    public static void wrapContent(LazyFile output, String content) {
        output.write("// generated by " + SdCardFieldsContent.class + "\n");
        output.write(BOARD_LOOKUP_H);
        output.write("static const LogField fields[] = {\n" +
                "{packedTime, GAUGE_NAME_TIME, \"sec\", 0},\n");
        output.write(content);
        output.write("};\n");
    }

    public void handleEndStruct(ReaderState state, ConfigStructure structure) throws IOException {
        if (state.isStackEmpty()) {
            PerFieldWithStructuresIterator.Strategy strategy = new PerFieldWithStructuresIterator.Strategy() {
                @Override
                public String process(ReaderState state, ConfigField configField, String prefix, int bitIndex) {
                    return processOutput(configField, prefix, bitIndex);
                }

                @Override
                public String getArrayElementName(ConfigField cf) {
                    return cf.getOriginalArrayName();
                }
            };
            PerFieldWithStructuresIterator iterator = new PerFieldWithStructuresIterator(state, structure.getTsFields(), "",
                    strategy, ".");
            iterator.loop();
            String content = iterator.getContent();
            body.append(content);
        }
    }

    private String processOutput(ConfigField configField, String prefix, int bitIndex) {
        if (configField.getName().startsWith(ConfigStructureImpl.ALIGNMENT_FILL_AT))
            return "";
        if (configField.getName().startsWith(ConfigStructure.UNUSED_ANYTHING_PREFIX))
            return "";

        String name = configField.getOriginalArrayName();

        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < home.length; i++) {
            String namePrefix = (names == null || names.length <= 1) ? "" : names[i];
            sb.append(getLine(
                configField,
                prefix,
                namePrefix,
                prefix + name,
                home[i],
                isPtr,
                conditional,
                0, // TODO: we need pass bits block offset here!!!
                bitIndex
            ));
        }

        return sb.toString();
    }

    private static String getLine(ConfigField configField, String prefix, String namePrefix, String name, String home, Boolean isPtr, String conditional, int bitsBlockOffset, int bitNumberInBitsBlock) {
        String categoryStr = configField.getCategory();

        if (categoryStr == null) {
            categoryStr = "";
        } else {
            categoryStr = ", " + categoryStr;
        }

        boolean isEnum = configField.getTypeName().contains("_e");
        if (isEnum)
            return "";

        String before = conditional == null ? "" : "#if " + conditional + "\n";
        String after = conditional == null ? "" : "#endif\n";

        if (configField.isBit()) {
            return before
                    + "\t/*{" +
                home +
                    ", " + Integer.toString(bitsBlockOffset) +
                    ", " + Integer.toString(bitNumberInBitsBlock) + ", "
                    + DataLogConsumer.getHumanGaugeName(prefix, configField, namePrefix) +
                    ", " +
                    quote(configField.getUnits()) +
                    categoryStr +
                    "},*/\n" +
                    after;
        } else {
            return before
                    + "\t{" +
                home + (isPtr ? "->" : ".") + name +
                    ", "
                    + DataLogConsumer.getHumanGaugeName(prefix, configField, namePrefix) +
                    ", " +
                    quote(configField.getUnits()) +
                    ", " +
                    configField.getDigits() +
                    categoryStr +
                    "},\n" +
                    after;
        }
    }

    public String getBody() {
        return body.toString();
    }
}
